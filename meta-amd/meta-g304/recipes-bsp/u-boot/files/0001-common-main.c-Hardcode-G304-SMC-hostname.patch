From c7c77a14c8b58fc6ee0e5ba22e35b794ecb6b84b Mon Sep 17 00:00:00 2001
Message-Id: <c7c77a14c8b58fc6ee0e5ba22e35b794ecb6b84b.1679413339.git.vinu.vaghasia@amd.com>
From: Vinu Vaghasia <vinu.vaghasia@amd.com>
Date: Tue, 21 Mar 2023 10:41:57 -0500
Subject: [PATCH] common/main.c: Hardcode G304 SMC hostname

1. Hardcoded G304 SMC hostname.

Signed-off-by: Supreeth Venkatesh <supreeth.venkatesh@amd.com>
Signed-off-by: Vinu Vaghasia <vinu.vaghasia@amd.com>
---
 common/image-fit.c |  2 +-
 common/main.c      | 10 +++++++++-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/common/image-fit.c b/common/image-fit.c
index fa5f141a81..6fcd314128 100644
--- a/common/image-fit.c
+++ b/common/image-fit.c
@@ -1977,7 +1977,7 @@ int fit_image_load(bootm_headers_t *images, ulong addr,
 					sprintf((char *)fit_uname_config, "conf-aspeed-bmc-amd-quartz.dtb");
 					break;
 			} // switch
-
+			sprintf((char *)fit_uname_config, "conf-aspeed-bmc-amd-g304.dtb");
 			cfg_noffset = fit_conf_get_node(fit,
 							fit_uname_config);
 		}
diff --git a/common/main.c b/common/main.c
index 1a98b3ea21..caf2dacaa1 100644
--- a/common/main.c
+++ b/common/main.c
@@ -175,7 +175,15 @@ void set_hostname()
 			printf("Hostname set to '%s'\n", hostname);
 		}
 		else
-			printf("Failed setting hostname, board_id or ethaddr is not set\n");
+		{
+			octate_5 = (int)simple_strtol(&ethaddr[OCTATE_5_OFFSET], NULL, HEX_BASE);
+			octate_6 = (int)simple_strtol(&ethaddr[OCTATE_6_OFFSET], NULL, HEX_BASE);
+			sprintf(hostname, "g304-%02x%02x", octate_5, octate_6);
+			sprintf(new_bootargs, "%s systemd.hostname=%s", cur_bootargs, hostname);
+			env_set("bootargs", new_bootargs);
+			env_save();
+			printf("Hostname set to '%s'\n", hostname);
+		}
 	}
 	else
 		printf("Hostname is already set with bootargs\n");
--
2.17.1

