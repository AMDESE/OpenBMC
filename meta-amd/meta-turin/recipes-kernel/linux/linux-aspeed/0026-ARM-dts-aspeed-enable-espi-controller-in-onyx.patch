From 119adc1785c2d3ff9c6a4621cd119b60a9b6a089 Mon Sep 17 00:00:00 2001
From: Rajaganesh Rathinasabapathi <Rajaganesh.Rathinasabapathi@amd.com>
Date: Tue, 24 Aug 2021 05:23:26 -0500
Subject: [PATCH] ARM dts aspeed enable espi controller in onyx

---
 arch/arm/boot/dts/aspeed-bmc-amd-onyx.dts | 24 ++++++++++++++-------
 arch/arm/boot/dts/aspeed-g6.dtsi          | 26 +++++++++++++++++++++++
 include/dt-bindings/clock/ast2600-clock.h |  4 ++++
 3 files changed, 46 insertions(+), 8 deletions(-)

diff --git a/arch/arm/boot/dts/aspeed-bmc-amd-onyx.dts b/arch/arm/boot/dts/aspeed-bmc-amd-onyx.dts
index 4f66efc31c1c..5b7413d5d22d 100644
--- a/arch/arm/boot/dts/aspeed-bmc-amd-onyx.dts
+++ b/arch/arm/boot/dts/aspeed-bmc-amd-onyx.dts
@@ -428,19 +428,26 @@
 	};
 };

-&kcs1 {
+&espi_ctrl {
 	status = "okay";
-	aspeed,lpc-io-reg = <0x60>;
-};

-&kcs2 {
-	status = "okay";
-	aspeed,lpc-io-reg = <0x62>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_espi_default &pinctrl_espialt_default>;
+
+	perif,memcyc-src-addr = <0x98000000>;
+	perif,memcyc-size = <0x10000>;
+	perif,dma-mode;
+
+	oob,dma-mode;
+	oob,dma-tx-desc-num = <0x2>;
+	oob,dma-rx-desc-num = <0x8>;
+
+	flash,dma-mode;
+	flash,safs-mode = <0x2>;
 };

-&kcs3 {
+&espi_mmbi {
 	status = "okay";
-	aspeed,lpc-io-reg = <0xCA2>;
 };

 &gpio0 {
diff --git a/arch/arm/boot/dts/aspeed-g6.dtsi b/arch/arm/boot/dts/aspeed-g6.dtsi
index 39331603657c..29091cb12434 100644
--- a/arch/arm/boot/dts/aspeed-g6.dtsi
+++ b/arch/arm/boot/dts/aspeed-g6.dtsi
@@ -380,6 +380,32 @@
 				status = "disabled";
 			};

+			espi: espi@1e6ee000 {
+				compatible = "aspeed,ast2600-espi", "simple-mfd", "syscon";
+				reg = <0x1e6ee000 0x1000>;
+
+				#address-cells = <1>;
+				#size-cells = <1>;
+				ranges = <0x0 0x1e6ee000 0x1000>;
+
+				espi_ctrl: espi-ctrl@0 {
+					compatible = "aspeed,ast2600-espi-ctrl";
+					reg = <0x0 0x800>;
+					interrupts-extended = <&gic GIC_SPI 42 IRQ_TYPE_LEVEL_HIGH>;
+					clocks = <&syscon ASPEED_CLK_GATE_ESPICLK>;
+					resets = <&syscon ASPEED_RESET_ESPI>;
+					aspeed,scu = <&syscon>;
+					status = "disabled";
+				};
+
+				espi_mmbi: espi-mmbi@800 {
+					compatible = "aspeed,ast2600-espi-mmbi";
+					reg = <0x800 0x50>;
+					interrupts = <GIC_SPI 108 IRQ_TYPE_LEVEL_HIGH>;
+					status = "disabled";
+				};
+			};
+
 			gpio0: gpio@1e780000 {
 				#gpio-cells = <2>;
 				gpio-controller;
diff --git a/include/dt-bindings/clock/ast2600-clock.h b/include/dt-bindings/clock/ast2600-clock.h
index dc812f0342b8..345598fe0446 100644
--- a/include/dt-bindings/clock/ast2600-clock.h
+++ b/include/dt-bindings/clock/ast2600-clock.h
@@ -100,6 +100,10 @@
 #define ASPEED_CLK_MAC4RCLK		74

 /* Only list resets here that are not part of a gate */
+#define ASPEED_RESET_FSI		59
+#define ASPEED_RESET_RESERVED58	58
+#define ASPEED_RESET_ESPI		57	//For AST2600A1
+#define ASPEED_RESET_SD			56
 #define ASPEED_RESET_ADC		55
 #define ASPEED_RESET_JTAG_MASTER2	54
 #define ASPEED_RESET_I3C6		46
--
2.17.1

