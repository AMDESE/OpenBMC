From 91da302e82a33576952990c342d08562fbfd05c3 Mon Sep 17 00:00:00 2001
From: Mohsen Dolaty <mohsen.dolaty@amd.com>
Date: Mon, 13 Dec 2021 14:37:44 -0600
Subject: [PATCH 1/1] phosphor-network: Add LCD write for BMC IP

Write BMC IP Address to LCD Line 2

Signed-off-by: Mohsen Dolaty <mohsen.dolaty@amd.com>
---
 ipaddress.cpp | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

diff --git a/ipaddress.cpp b/ipaddress.cpp
index f30cf34..80cacfd 100644
--- a/ipaddress.cpp
+++ b/ipaddress.cpp
@@ -1,3 +1,5 @@
+#include <lcdlib_common.h>
+
 #include "config.h"

 #include "ipaddress.hpp"
@@ -8,16 +10,32 @@
 #include <phosphor-logging/elog-errors.hpp>
 #include <phosphor-logging/log.hpp>
 #include <xyz/openbmc_project/Common/error.hpp>
+
 namespace phosphor
 {
 namespace network
 {
+#define LCD_MAX_CHAR  20
+#define LCD_BUFF_SIZE 2*LCD_MAX_CHAR

 using namespace phosphor::logging;
 using namespace sdbusplus::xyz::openbmc_project::Common::Error;
 using NotAllowed = sdbusplus::xyz::openbmc_project::Common::Error::NotAllowed;
 using Reason = xyz::openbmc_project::Common::NotAllowed::REASON;

+static void writeLCD(char *ip)
+{
+    if (lcdlib_open_dev() != 0 ) {
+        log<level::ERR>("writeLCD Error: Could not open LCD device\n");
+        return;
+    }
+    if (lcdlib_write_string(BMC_IPADDR, (unsigned char*)ip, LCD_MAX_CHAR) !=0)
+        log<level::ERR>("writeLCD Error: Could not wirte BMC IP to LCD \n");
+    if (lcdlib_close_dev() != 0 )
+        log<level::ERR>("writeLCD Error : Failed to close LCD device\n");
+    return;
+}
+
 IPAddress::IPAddress(sdbusplus::bus::bus& bus, const char* objPath,
                      EthernetInterface& parent, IP::Protocol type,
                      const std::string& ipaddress, IP::AddressOrigin origin,
@@ -25,12 +43,20 @@ IPAddress::IPAddress(sdbusplus::bus::bus& bus, const char* objPath,
     IPIfaces(bus, objPath, true),
     parent(parent)
 {
+    char ip[LCD_BUFF_SIZE];

     IP::address(ipaddress);
     IP::prefixLength(prefixLength);
     IP::gateway(gateway);
     IP::type(type);
     IP::origin(origin);
+    // LCD
+    snprintf(ip, LCD_BUFF_SIZE, "%s", address().c_str());
+    // skip IPV6
+    if (strstr(ip,":") == 0) {
+        snprintf(ip, LCD_BUFF_SIZE, "IP: %s    ", address().c_str());
+        writeLCD(ip);
+    }

     // Emit deferred signal.
     emit_object_added();
--
2.25.1
